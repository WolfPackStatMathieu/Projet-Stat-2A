---
title: "Cahier de suivi Projet Statistique Sujet 23"
author: "NEBANGA KANGA-NZANGA Odilon cyrille, GORSE Nathan, THOMASSIN Mathieu"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(dfcrm)
source("MainFunctions_Andrillon_JBS_2020.R")
source("crm_simul.R")

```

## 1 To do list

-   Revoir modele de survie et vraisemblance
-   Tenter √©crire vraisemblance du mod√®le de gu√©rison (produit des
    contributions des sujets dans les deux sous-populations)
-   Donn√©es
-   
    -   Utiliser mod√®le puissance pour analyse donn√©es
-   
    -   Utiliser mod√®le de survie apr√®s avoir simul√© des d√©lais
-   $\mathrm{R}$
-   dfcrm Code joint
-   Fonctions article anais andrillon

### 1 Revoir mod√®le de survie et vraisemblance

La fonction de survie du modele de guerison vaut : $$
P(T>=t)=\pi(z) \times S_{U}(T>=t)+1-\pi(z) \qquad (1)$$
O? $T$ est le temps d'apparition de la toxicit√© chez le sujet, $\pi(\cdot)$ est la proportion de sujets ayant manifest√© une toxicit√© durant la fen√™tre d'observation (la proportion de sujets non gu√©ris), $S_U(\cdot)$ est la fonction de survie des sujets non gu√©ris.

### 2 Tenter √©crire vraisemblance du mod√®le de gu√©rison (produit des contributions des sujets dans les deux sous-populations)

Pour √©crire la vraisemblance du mod√®le, il faut distinguer deux cas.
Dans le premier cas, on conna√Æt la valeur de T qui n'a pas √©t√© censur√©e.
L'individu a par cons√©quent bien manifest√© la toxicit√© dans la fen√™tre
[0,t\*]. La contribution pour ces individus √† la vraisemblance
correspond alors √† la fonction de densit√© sachant $U(Y=1)$ soit : 
$$
f(t_i|x_i)=\pi(x_{i})*f_{U}(t)
$$
O? $f_U(\cdot)$ est la densit? de $T$ chez les sujets non gu√©ris.

A l'inverse, pour les individus n'ayant pas manifest√© de toxicit√© durant cette fen√™tre, on ne conna√Æt pas T. Autrement dit, Y=0. Par cons√©quent, on sait juste que T est sup√©rieure √† une certaine valeur. On mobilise par cons√©quent la fonction de survie donn√©e dans l'√©quation
(1). La vraisemblance vaut donc :

$$
L(X,Y)= \prod_{i=1}^{n} \pi(x_{i}) \times f_{U}(t_{i})^{Y_{i}} \times S(t_{i}|x_{i})^{1-Y_{i}}
$$
$$
=\displaystyle \prod_{i=1}^{n} \pi(x_{i}) \times f_{U}(t_{i})^{Y_{i} } \times \Biggl( S_{U} \left(t_{i} \right)\times\pi \left( x_{i} \right)+\Bigl( 1-\pi \left( x_{i} \right) \Bigr) \Biggr)^{1-Y_{i}}
$$

## 3 Utiliser mod√®le puissance pour analyse donn√©es

### Utilisation de CRM Installation du package

```{r}
require(dfcrm)
# help(dfcrm)
source("fonctions.R")
```

Nous entrons les donn√©es des doses administr√©es √† chaque patient telles
qu'indiqu√©s dans la colonne de gauche du tableau suivant.

$$
\begin{array}{cc}
\begin{array}{c}
\text { Administrated dose } \\
\left.\mathbf{( m g}.\mathbf{m}^{-2}.\mathbf{d a y}^{-1}\right)
\end{array} & \begin{array}{c}
\text { Clinical } \\
\text { response }
\end{array} \\
\hline 0.5 & \text { NT NT NT } \\
3 & \text { NT NT T } \\
5 & \text { NT NT T } \\
5 & \text { NT NT NT } \\
5 & \text { NT T NT } \\
5 & \text { T NT T } \\
\hline
\end{array}
$$

```{r}
vecteur_dose<-c(rep(0.5,3),rep(3,3),rep(5,4*3))
```

Puis les donn√©es de l'effet du traitement sur chaque patient ("Clinical
response").

```{r}
vecteur_reponse<-c(rep(0,3),0,0,1,0,0,1,rep(0,3),0,1,0,1,0,1)
```

Nous indiquons les doses administr√©es.

```{r}
nom_dose<-c("0.5","1","3","5","6")
```

Nous faisons un dataframe reliant ces deux vecteurs.

```{r}
valeurs_dose_toxicite<-cbind.data.frame(vecteur_dose,vecteur_reponse)
```

Nous entrons les valeurs de probabilit√©s de toxicit√© des doses a priori
fournies par le tableau suivant:

$$
\begin{array}{ccccccccc}
\hline \text{HHT-loading dose } \left(\mathbf{m g ~ m}^{-2}\right. day \left.^{-1}\right) & 0.5 & 1 & 3 & 5 & 6\\
\hline \text {Initial guesses of toxicity probability } & 0.05 & 0.1 & 0.15 & 0.33 & 0.50\\
\hline
\end{array}
$$

```{r}
prior_probabilities <- c(0.05,0.1,0.15,0.33,0.5) 
```

Nous assignons la valeur de toxicit√© limitante (Dose Limiting Toxicity)

```{r}

```

Nous appliquons la fonction crm aux donn√©es, avec le mod√®le puissance et
affichons les donn√©es

```{r}
p <- 0.33
infos<-crm(prior=prior_probabilities,target=p,vecteur_reponse,vecteur_dose,18) # puissance avec empiric
infos
```

On remarque que la probabilit√© de toxicit√© augmente au fur et √† mesure que
le niveau de dose augmente.Et que la prochaine dose recommand√©e est de 5 par 
rapport √† la valeur cible p=0.3 de DLT.
La variance post√©rieure de b√™ta √©tant faible, cela indique que les donn√©es 
sont informatives sur le param√®tre b√™ta. Ce qui semble sugg√©rer que le
mod√®le est adapt√© aux donn√©es.

```{r echo=FALSE}
plot.mtd(infos)
```


## 4 Utiliser mod√®le de survie apr√®s avoir simul√© des d√©lais

```{r}
#######Modele de survie logistique.###### #titre √† effacer
###################################
####################

#####I) Simulation des donn√©es et import des donnees simulees.######
#####On utilise le code fourni pour g√©n√©rer les donn√©es. 
N=18
res <- titesim(PI=c(0.05, 0.1, 0.15, 0.33, 0.50), 
               prior=getprior(0.05, 0.25, 2, 5), 
               0.25, N, 1,
               obswin=6,restrict=1,
               rate=3,
               accrual = "poisson", seed=1234)

prior<-c(0.05, 0.25, 2, 5)
base_tox <- data.frame(id=1:N, dose=res$level, time_arrival=res$arrival, toxicity.study.time=res$toxicity.study.time, toxicity.time=res$toxicity.time)
head(base_tox)
base_tox$toxicity.study.time[base_tox$toxicity.study.time==Inf] <- NA
base_tox$toxicity.time[base_tox$toxicity.time==Inf] <- NA
base_tox$toxicity.study.time <- round(base_tox$toxicity.study.time, 2)
base_tox$toxicity.time <- round(base_tox$toxicity.time, 2)
base_tox$time_arrival <- round(base_tox$time_arrival, 2)
essai_n18 <- base_tox
essai_n18
plot(essai_n18)
#####On cree une base de donn√©es. 
write.table(essai_n18, file="essai_n18.txt", sep="\t", row.names=F)
donnees<-read.table("essai_n18.txt",header=TRUE)

```

```{r}
#######II) Creation des arguments. ######

#Vecteur reponse avec reponse=1 si le temps d'apparition de la toxicit√© est connu. 
#Le vecteur reponse vaut 0 sinon. 
#Dans notre cas, on donne 0 si le temps d'apparition  de la toxicit√© est NA.
vecteur_reponse<-ifelse(is.na(donnees$toxicity.time)==FALSE,1,0)
t<-6
#Les doses administr√©es a chaque patient sont donn√©es par la colonne dose. 
level_dose<-donnees$dose

#la date de sortie est donnee par la colonne toxicity.study.time. 
observations_time<-ifelse(!is.na(donnees$toxicity.time),donnees$toxicity.time,t)
valeur_dose<-c(0.5,1,3,5,6)
id_dose<-donnees$dose
vecteur_reponse<-ifelse(is.na(donnees$toxicity.time)==FALSE,1,0)
tstar<-6
```
Comme nous ne voulions pas utiliser directement l'inference bayesienne, nous avons utilis√© 2 m√©thodes pour estimer le Beta. La premi√®re se base sur l'article fourni. La seconde methode consiste √† utiliser plusieurs points initiaux. Nous utilisons la fonction modele_survie_bayes pour l'inference bayesienne.Nous sommes dans le cas o? la fonction de densit? f suit une loi exponentielle :
$$
\lambda(t)=exp(exp(\beta)*dose)
$$
La fonction de survie correspond ?:
$$
S(t)=exp(-\lambda*t)=exp(-exp(exp(\beta)*dose)*t)
$$
```{r }

#Rappel: 
#Nous sommes dans le cadre ou la fonction de survie 
#suit une loi exponentielle de parametre exp(-xi*exp(beta)). Notons epsi cette valeur. 
# donc la fonction de densite est :
#epsi*exp(-epsi*t) [fonction densit√© d'une loi exponentielle.]
skeleton <- getprior_exp(halfwidth=0.05, target=p, nu=4, nlevel=5, tstar=6) 
xref <-  log(-log(1-skeleton)/6)
test<-modele_survie_bayes(p,tstar,observations_time,id_dose,valeur_dose = xref,vecteur_reponse = vecteur_reponse )
```
Deux m√©thodes ont √©t√© envisag√©es avec l'utilisation d'un ensemble de beta possibles ou l'utilisation de l'algorithme de Newton, avec la fonction nlm.  
```{r}
windows<-runif(10,-0.1,0)
beta_init<-1
test_beta<-modele_survie_sans_hypotheses(observations_time = observations_time,id_dose=id_dose,vecteur_reponse = vecteur_reponse,valeur_dose =xref,windows=windows)
test_beta_Newton<-modele_survie_Newton(observations_time = observations_time,id_dose=id_dose,vecteur_reponse =vecteur_reponse,valeur_dose=xref,beta_init =beta_init)$estimate

```
Nous avons essay√© de mani√®re exp√©rimentale de trouver $\hat{\beta}$ en combinant ces deux mani√®res de faire. 
```{r}
######On remarque que la valeur de beta selon l'algorithme de Newton peut beaucoup varier. Par ailleurs, la log -vraisemblance a ete choisie 
##### car la vraisemblance ne permettait pas d'avoir des iterations. En effet, la valeur du gradient etait trop faible
#### au point initial. 
#fenetre<-runif(10,-10,-1)
##### Autre methode, utiliser plusieurs points initiaux. ####
#test_beta_newton_multiple<-modele_survie_Newton_multiple(observations_time = observations_time,id_dose=id_dose,
                                                         #valeur_dose =xref,
                                                         #vecteur_reponse = vecteur_reponse,
                                                         #fenetre)
```
###4 Courbe dose/toxicit?. 
#### a) par l'algorithme de Newton
```{r}
y_proba<-1-exp(-lambda(beta=test_beta,x=xref)*tstar)
plot(x=c(1:5),y=y_proba,type="l",xlab="Index",ylab="Probabilit? de DLT",main="Essai avec la methode d'un ensemble de beta")
abline(h=p,col="red")
```
On prendrait selon le graphique la dose 4.
```{r}
beta_Newton<-test_beta_Newton
y_proba2<-1-exp(-lambda(beta=beta_Newton,x=xref)*tstar)
plot(x=c(1:5),y=y_proba2,type="l",xlab="Index de la dose",ylab="Probabilit? de DLT",main="Essai avec l'algorithme de Newton")
abline(h=p,col="red")
```
Nous prendrions la dose num?ro 5 selon cet algorithme. 
Nous pouvons aussi projeter les valeurs avec le mod?le bay?sien. La ligne bleue correspond aux probablit?s a posteriori.
```{r}
afficher_resultat(beta=test_bayes,x_ref,skeleton)
```
Le graphique permet de voir que la dose utilis?e serait la dose 5.
####b) Mod√®le logit.
Nous pouvons utiliser d'autres m?thodes ne mobilisant pas la logique bay?sienne. Les m?thodes glm permettent notamment d'expliquer la probabilit? que Y vaille 1 c'est-?-dire que l'individu manifeste la toxicit?. 
```{r}
donnees2<-cbind.data.frame(donnees,dlt,xref[donnees$dose])
logit_proba_dlt<-glm(dlt~xref[donnees$dose],data=donnees2,family =binomial(link="logit"))
#beta0<-logit_proba_dlt$coefficients[["(Intercept)"]]
beta1<-logit_proba_dlt$coefficients[["xref[donnees$dose]"]]
y_predicted<-sapply(xref[c(1:5)],fonction_logit,beta0=beta0,beta1=beta1)
plot(x=c(1:5),y=y_predicted,xlab="Index de la dose",ylab="Valeur de la probabilit?",main="M?thode logit",col="red")

```
<<<<<<< HEAD
Le modËle logit est davantage ambig¸e vis-‡-vis du choix de la dose.
##5) Simulation de temps.
```{r}
#############calcul_temps.#######
n<-18
beta<-0.5
k<-3
temps_simul_exp<-simul_temps_exp(n,beta)
ks.test(temps_simul_exp,"pexp")
temps_weibull<-simul_temp_weibull(n,beta,k)
```

=======
Le mod?le logit est davantage ambig?e vis-?-vis du choix de la dose.
####c) par Kaplan-Meier
```{r include=FALSE}
# Load required packages
library(survival)
#install.packages("survminer")
library(survminer)
library(dplyr)
library(dfcrm)

####### Simulation des donn√©es ####################
N=100 #Nombre de patients simul√©s
p<-0.33 # Valeur limite de toxicit√©
#Simulation des donn√©es par la fonction titesim
res <- titesim(PI=c(0.05, 0.1, 0.15, 0.33, 0.50), 
               # prior=getprior(0.05, 0.25, 2, 5),
               prior=getprior(0.05, 0.25, 2, 5), 
               0.25, N, 1,
               obswin=6,
               restrict=1,
               rate=3,
               accrual = "poisson", seed=1234)

#Cr√©ation d'un dataframe avec ces valeurs
base_tox <- data.frame(id=1:N, dose=res$level, time_arrival=res$arrival, toxicity.study.time=res$toxicity.study.time, toxicity.time=res$toxicity.time)
head(base_tox)
#Transformation des valeurs de la variable toxicity.study.time en NA si Inf
base_tox$toxicity.study.time[base_tox$toxicity.study.time==Inf] <- NA
#idem pour toxicity.time
base_tox$toxicity.time[base_tox$toxicity.time==Inf] <- NA
#On arrondit les valeurs √† 2 chiffres apr√®s la virgule
base_tox$toxicity.study.time <- round(base_tox$toxicity.study.time, 2)
base_tox$toxicity.time <- round(base_tox$toxicity.time, 2)
base_tox$time_arrival <- round(base_tox$time_arrival, 2)


essai_n18 <- base_tox
essai_n18
plot(essai_n18)
#####On √©crit une base de donn√©es. 
write.table(essai_n18, file="essai_n18.txt", sep="\t", row.names=F)
donnees<-read.table("essai_n18.txt",header=TRUE)
head(donnees)


donnees$temps <- donnees$toxicity.study.time - donnees$time_arrival
head(donnees)

####Kaplan-Meier et proportion de non toxicit√© √† la fin de la fen√™tre d'observation#######

#time_arrival  : quand est-ce que le patient arrive
# toxicity.study.time : le temps mis pour d√©velopper la toxicit√©
# toxicity.time = toxicity.study.time - time_arrival

#on cr√©e une variable indiquant si l'observation a √©t√© 
#censur√©e ou non. 0= non censur√©e ; 1 = a √©t√© censur√©e.
donnees$isobserved <- ifelse(is.na(donnees$toxicity.study.time), 0, 1)
#quand il voit iscensored = 1, il ne met pas de +
head(donnees)
summary(donnees)
donnees$toxicity.time <- ifelse(is.na(donnees$toxicity.time), 6, donnees$toxicity.time)
head(donnees)
table(donnees$isobserved)
# Fit survival data using the Kaplan-Meier method
surv_object <- Surv(time = donnees$toxicity.time, event = donnees$isobserved)
surv_object


fit <- survfit(surv_object ~ dose, data = donnees)
summary(fit)
```






>>>>>>> b7c3a7d463521b102cd96e952867469a7e67f422
